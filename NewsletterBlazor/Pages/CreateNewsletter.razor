@using Microsoft.AspNetCore.Identity;
@using NewsletterBlazor.Data;
@using NewsletterBlazor.Data.Entities;

@attribute [Authorize(Roles = "User")]

@inject UserManager<IdentityUser> _userManager
@inject ApplicationDbContext _context
@inject ILogger<CreateNewsletter> _logger
@inject IConfiguration _configuration
@inject AuthenticationStateProvider _AuthenticationStateProvider

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">
    <EditForm Model="@_mailModel" OnInvalidSubmit="@HandleForm">
        <MudCard Elevation="5">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h4">Mail</MudText>
                </CardHeaderContent>

                <CardHeaderActions>
                    <MudButton ButtonType="ButtonType.Reset" StartIcon="@Icons.Material.Filled.Restore" >Reset fields</MudButton>
                </CardHeaderActions>
            </MudCardHeader>

            <MudCardContent>
                <MudTextField Class="pa-2" Label="Subject" T="string" @bind-Value="@_mailModel.Subject" Required="true" Variant="Variant.Outlined"/>

                <MudTextField Class="pa-2" Label="Body" T="string" @bind-Value="@_mailModel.Body" Lines="10" Required="true" Variant="Variant.Outlined"/>

                <MudCheckBox T="bool" @bind-Checked="@_mailModel.IsHTML" Label="Is Body HTML" LabelPosition="LabelPosition.Start" Size="Size.Medium" Class="mt-4" />
                
                <MudFileUpload T="IReadOnlyList<IBrowserFile>" FilesChanged="@UploadFiles" MaximumFileCount="5">
                    <ButtonTemplate>
                        <MudButton HtmlTag="label"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                   >
                            Attach files
                        </MudButton>
                    </ButtonTemplate>
                </MudFileUpload>
                
                <MudText Typo="Typo.subtitle1" Align="Align.Left" Color="Color.Success">Selected files:</MudText>
                
                @foreach (var item in _attachtments)
                {
                    <MudText Typo="Typo.subtitle2" Align="Align.Center">@item.Name, @item.Size</MudText>
                }

            </MudCardContent>
            
            <MudCardActions>
                <ValidationSummary/>
                <DataAnnotationsValidator/>
            </MudCardActions>
        </MudCard>
        
        <MudCard Elevation="5" Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">Actions</MudText>
                </CardHeaderContent>
            </MudCardHeader>

            <MudCardContent>
                <MudFileUpload T="IBrowserFile" FilesChanged="LoadReceivers" Accept=".txt" Required="true" @bind-Value="_receiversFile">
                    <ButtonTemplate Context="AnotherContext">
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.AttachFile" HtmlTag="label">
                            Attach Receivers
                        </MudButton>
                    </ButtonTemplate>
                </MudFileUpload>
            </MudCardContent>
            
            <MudCardActions>
                <MudButton ButtonType="ButtonType.Submit" Color="Color.Success" Variant="Variant.Filled">Send</MudButton>
            </MudCardActions>
        </MudCard>
    </EditForm>
</MudContainer>

<MudContainer MaxWidth="MaxWidth.Small">
    <MudText Color="Color.Success" Align="Align.Center">@_state.Success</MudText>
    <MudText Color="Color.Warning" Align="Align.Center">@_state.Warning</MudText>
    <MudText Color="Color.Error" Align="Align.Center">@_state.Error</MudText>
</MudContainer>

@if (IsSending & _receiversList.Count > 0)
{
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudProgressLinear Value="@ActualEmail" Min="1" Max="@_receiversList.Count" Color="Color.Secondary" Rounded="true" Size="Size.Medium">
            <MudText Typo="Typo.subtitle1">Progress: @ActualEmail / @_receiversList.Count</MudText>
        </MudProgressLinear>
    </MudContainer>
}

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-5 d-flex flex-row gap-4 justify-center">
    <MudContainer>
        <MudCard Elevation="5">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.body1">All selected mails</MudText>
                </CardHeaderContent>
            </MudCardHeader>
        
            <MudCardContent>
                @if (_receiversList.Count > 0)
                {
                    @if(_receiversList.Count <= 5)
                    {
                        @foreach (var item in _receiversList)
                        {
                            <MudText Color="Color.Info" Typo="Typo.subtitle1">@item</MudText>
                        }
                    }
                    else
                    {
                        @for (int i = 0; i < 5; i++)
                        {
                            <MudText Color="Color.Info" Typo="Typo.subtitle1">@_receiversList[i]</MudText>
                        }
                        <MudText Color="Color.Info" Typo="Typo.subtitle1">... @(_receiversList.Count - 5) more</MudText>
                    }
                }
                else
                {
                    <MudText Typo="Typo.subtitle1">Not selected receivers yet</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudContainer>
    
    <MudSpacer/>

    <MudContainer>
        <MudCard Elevation="5">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.body1">Mails that throwed errors</MudText>
                </CardHeaderContent>
            </MudCardHeader>
        
            <MudCardContent>
                @if (_badReceivers.Count > 0)
                {
                    @foreach (var item in _badReceivers)
                    {
                        <MudText Color="Color.Error" Typo="Typo.subtitle1">@item</MudText>
                    }
                }
                else
                {
                    <MudText Typo="Typo.subtitle1">There is not any bad email yet</MudText>
                }
            </MudCardContent>
            <MudCardActions>
                <MudButton Color="Color.Success" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Try">Try again</MudButton>
            </MudCardActions>
        </MudCard>
    </MudContainer>
</MudContainer>